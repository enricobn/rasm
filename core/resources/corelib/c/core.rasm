pub type RasmPointer /{
    hasReferences = false,
    nativeType = struct RasmPointer_*
}/

pub native exitMain(status: int) /{
    exit($status);
}/

pub native argc() -> int /{
    return argc_;
}/

pub native argv(i: int) -> Option<str> /{
    if (i >= argc_) {
        $enumSimple(result, None)
        return result;
    } else {
        struct RasmPointer_ *argv = addStaticStringToHeap(argv_[$i]);
        $addRef(argv:str)
        return
        $call(Some, argv:str)
        ;
    }

}/

pub native deref(address: RasmPointer) /{
    $include(<stdlib.h>)

    #ifdef __RASM_DEBUG__
    if ($address == NULL) {
        printf("NULL address\n");
        return;
    }

    printf("deref(%p)", $address->address);
    #endif

    if (--$address->count == 0) {
        push_zero($address);
    }
}/

pub native addRef(address: RasmPointer) /{
    $include(<stdlib.h>)

    #ifdef __RASM_DEBUG__
    if ($address == NULL) {
        printf("NULL address\n");
        return;
    }

    printf("addRef(%p)", $address->address);
    #endif

    if (++$address->count == 1) {
        if ($address->zero != NULL) {
            remove_from_zero_list($address->zero);
            $address->zero = NULL;
        }
    }
}/

pub native freeReferences() /{
    free_zero();
}/